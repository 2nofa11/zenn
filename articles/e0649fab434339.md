---
title: "VueでもTanStack Formを試したい!"
emoji: "🌊"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Vue","TanStack","TypeScript"]
published: false
---

## TanStack Formについて

[TanStack](https://tanstack.com/)はReactの文脈で語られることが多いですが、ヘッドレスなライブラリ群なのでReact以外のユーザーも利用できる機能がいくつか存在します。
具体的には`TanStack Query`や`TanStack Router`、最近だと`TanStack AI`が発表されましたが、その中にはフォームを取り扱った`TanStack Form`というものがあります。
`TanStack Form`の公式説明によると、`Headless UI for building performant and type-safe forms`（高性能で型安全なフォームを構築するためのヘッドレスUI）ライブラリです。

Vue.jsでも`TanStack Form`を利用できるとのことなので、試しに動かしてみようと思います。

## 実装例

### フォームの要件

* 名前を登録するフォーム
* バリデーション条件
    * サブミット時、ブラー時で検知
* バリデーション内容
    * 空文字入力の場合

### 素のVueで実装

以下のようになります。


```vue
<script setup lang="ts">
import { ref, computed } from 'vue'

const userName = ref('')
const userNameTouched = ref(false)

const userNameError = computed<string | null>(() => {
  if (!userNameTouched.value) return null
  if (!userName.value) {
    return '名前は必須です'
  }
  return null
})

const handleSubmit = async (e: Event) => {
  userNameTouched.value = true
  if (userNameError.value) return
  alert(userName.value)
}
</script>

<template>
  <form @submit.prevent.stop="handleSubmit">
    <div>
      <label for="userName">名前</label>
      <input
        id="userName"
        name="userName"
        v-model="userName"
        @blur="userNameTouched = true"
      />
      <p v-if="userNameError">{{ userNameError }}</p>
    </div>
    <button type="submit">Submit</button>
  </form>
</template>
```

要件自体はシンプルですが、ブラー用やエラー判定用のリアクティブな値を持っており、バリデーションが複雑になるとコードから仕様を理解することに苦労しそうですね。

### TanStack Formを使った書き方

TanStack Formで上記の内容を書く場合、以下の書き方になります。

```vue
<script setup lang="ts">
import { useForm } from '@tanstack/vue-form';

const nameForm = useForm({
  defaultValues: { userName: '' },
  onSubmit: async ({ value }) => {
    alert(value.userName);
  },
});

const validateUserName = ({ value }: { value: string }) => {
  if (!value) return '名前は必須です';
  return undefined;
};
</script>

<template>
  <form @submit.prevent.stop="nameForm.handleSubmit">
    <div>
      <nameForm.Field
        name="userName"
        :validators="{ onBlur: validateUserName, onSubmit: validateUserName }"
      >
        <template v-slot="{ field }">
          <label :for="field.name">名前</label>
          <input
            :id="field.name"
            :name="field.name"
            :value="field.state.value"
            @input="(e) => field.handleChange(e.target.value)"
            @blur="field.handleBlur"
          />
          <p v-if="field.state.meta.errors.length">
            {{ field.state.meta.errors[0] }}
          </p>
        </template>
      </nameForm.Field>
    </div>
    <button type="submit">Submit</button>
  </form>
</template>
```

かなり違いますね。
必要な部分だけ抜粋しつつ、1つずつ見ていきましょう。

1. `useForm`

  まず、`@tanstack/vue-form`からimportした`useForm`を利用しています。宣言的にフォームの挙動を書くことができます。 

[^1]: [公式のコード](https://tanstack.com/form/latest/docs/overview#enough-talk-show-me-some-code-already)では`useForm`の戻り値を`form`としていましたが、説明がわかりづらくなると判断して`nameForm`としています。

  ```ts
  const nameForm = useForm({
    defaultValues: { userName: '' },
    onSubmit: async ({ value }) => {
      alert(value.userName);
    },
  });
  ```

  次に、`useForm`の戻り値をtemplate内で利用します。
  templateに`userName`を連携するには以下のように記述します。

  ```vue
  <nameForm.Field name="userName">
    <template v-slot="{ field }">
      <label :for="field.name">名前</label>
      <input
        :name="field.name"
        :value="field.state.value"
      />
    </template>
  </nameForm.Field>
  ```

上記のコードで行っていることは以下の通りです。
  ①`nameForm.Field`というタグで囲んで`useForm`内で設定した値を`name`属性に指定する（今回の場合は`name="userName"`）
  ②スロットコンテンツに`field`を渡す
  ③スロット内部にinput要素を`field`経由で記述する。`field`を使うことで`useForm`で指定した値に連動できる

2. バリデーション

Fieldコンポーネントの`validators`プロパティにonBlurやonSubmitの関数を設定することでバリデーションを実施できます。
バリデーションの発火タイミングは、Fieldの`validators`に記述できます。今回の場合はonBlurとonSubmitを指定しています。
また、エラーの内容は`field.state.meta.errors`に格納されるので、その内容を表示するだけで管理できます。

```vue
<form @submit.prevent.stop="nameForm.handleSubmit">
  <nameForm.Field
    name="userName"
    :validators="{ onBlur: validateUserName, onSubmit: validateUserName }"
  >
    <template v-slot="{ field }">
      <input
        :value="field.state.value"
        @input="(e) => field.handleChange((e.target as HTMLInputElement).value)"
      />
      <p v-if="field.state.meta.errors.length">
        {{ field.state.meta.errors[0] }}
      </p>
    </template>
  </nameForm.Field>
</form>
```


## 感想

素のVueで書くより覚えることが多いと感じましたが、処理の流れが一方通行になっている点は良いと感じました。
実務では今回の要件より複雑になるケースがほとんどだと思うので、導入することによって見通しが良くなりそうです。

## 参考

- [TanStack Form公式ドキュメント](https://tanstack.com/form/latest/docs/framework/vue/guides/basic-concepts)
- [TanStack Form Vue サンプル（StackBlitz）](https://stackblitz.com/github/tanstack/form/tree/main/examples/vue/simple?embed=1&theme=dark&preset=node&file=src/App.vue)
