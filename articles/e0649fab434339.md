---
title: "VueでもTanstackが使いたい!!!~TanStack Form編~"
emoji: "🌊"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Vue","TanStack","TypeScript"]
published: false
---

## 導入部
Reactの文脈でTanstackは語られることが多いが、Tanstackはヘッドレスなユーティリティ群なのでReact以外のユーザも利用できる機能がいくつか存在します。
Tanstackを学習することはフレームワークに縛られることなくフロントエンド開発者の知見につながる。

## 課題提起
フロントエンド開発におけるテーブルやフォーム、データ取得などの実装が複雑になる箇所をTanstackを使うことでどのようにシンプルに実装できるのか？

## 解決策

今回は例としてTanstackFormを使ってみて、どのような実装になるか試してみる。
もちろんVueで！

### フォームの要件
* 姓と名とを登録するフォーム
* バリデーション条件
    * ブラーしたタイングで検知
* バリデーション内容
    * 姓のみ、6文字以上だった場合
    * 空文字入力の場合


## 実装例

### 素のVueで実装

以下のようになります。


``` vue
<script setup lang="ts">
import { ref, computed } from 'vue'

const lastName = ref('')
const firstName = ref('')

const lastNameTouched = ref(false)
const firstNameTouched = ref(false)

const lastNameError = computed<string | null>(() => {
  if (lastNameTouched.value) return null
  if (!lastName.value) {
    return '姓は必須です'
  }
  if (lastName.value.length > 6) {
    return '姓は6文字以内で入力してください'
  }
  return null
})

const firstNameError = computed<string | null>(() => {
  if (!firstNameTouched.value) return null
  if (!firstName.value) {
    return '名は必須です'
  }
  return null
})

const canSubmit = computed(() => !firstNameError.value && !lastNameError.value)

const handleSubmit = async (e: Event) => {
  firstNameTouched.value = true
  lastNameTouched.value = true

  if (!canSubmit.value) return

  alert(`${lastName.value} ${firstName.value}`.trim())
}
</script>

<template>
  <form @submit.prevent.stop="handleSubmit">
    <div>
      <label for="lastName">姓</label>
      <input
        id="lastName"
        name="lastName"
        v-model="lastName"
        @blur="lastNameTouched = true"
      />
      <p v-if="lastNameError">
        {{ lastNameError }}
      </p>
    </div>

    <div>
      <label for="firstName">名</label>
      <input
        id="firstName"
        name="firstName"
        v-model="firstName"
        @blur="firstNameTouched = true"
      />
      <p v-if="firstNameError">
        {{ firstNameError }}
      </p>
    </div>

    <button type="submit">
      Submit
    </button>
  </form>
</template>

```

要件自体はシンプルですが、ブラー用、エラー判定用にリアクティブな値を持っており、バリデーションが複雑になるとコードから仕様を理解することに苦労しそうですね。
また、ブラーのイベントで状態を更新しているので、どこで状態が切り替わっているのか迷いそうです。


### TanstackFormを使った書き方

TanstackFormで上記の内容を書く場合、以下の書き方になります。

``` vue
<script setup lang="ts">
import { useForm } from '@tanstack/vue-form';

const form = useForm({
  defaultValues: {
    lastName: '',
    firstName: '',
  },
  onSubmit: async ({ value }) => {
    alert(`${value.lastName} ${value.firstName}`.trim());
  },
});

const validateLastName = ({ value }: { value: string }) => {
  if (!value) {
    return '姓は必須です';
  }
  if (value.length > 6) {
    return '姓は6文字以内で入力してください';
  }
  return undefined;
};

const validateFirstName = ({ value }: { value: string }) => {
  if (!value) {
    return '名は必須です';
  }
  return undefined;
};
</script>

<template>
  <form
    @submit.prevent.stop="
      () => {
        form.handleSubmit();
      }
    "
  >
    <div>
      <form.Field
        name="lastName"
        :validators="{
          onBlur: validateLastName,
          onSubmit: validateLastName,
        }"
      >
        <template #default="{ field }">
          <label :for="field.name">姓</label>
          <input
            :id="field.name"
            :name="field.name"
            :value="field.state.value"
            @input="(e) => field.handleChange(e.target.value)"
            @blur="field.handleBlur"
          />
          <p v-if="field.state.meta.errors.length">
            {{ field.state.meta.errors[0] }}
          </p>
        </template>
      </form.Field>
    </div>

    <div>
      <form.Field
        name="firstName"
        :validators="{
          onBlur: validateFirstName,
          onSubmit: validateFirstName,
        }"
      >
        <template #default="{ field }">
          <label :for="field.name">名</label>
          <input
            :id="field.name"
            :name="field.name"
            :value="field.state.value"
            @input="(e) => field.handleChange(e.target.value)"
            @blur="field.handleBlur"
          />
          <p v-if="field.state.meta.errors.length">
            {{ field.state.meta.errors[0] }}
          </p>
        </template>
      </form.Field>
    </div>

    <button type="submit">Submit</button>
  </form>
</template>
```

かなり違いますね。
必要な部分だけ抜粋しつつ、１つずづ見ていきましょう。

1. useForm
`@tanstack/vue-form`からuseFormを利用しています。宣言的にフォームの挙動を書くことができます。
useFormの戻り値であるformをtemplate内で利用します。
利用方法は
①`form.Field`というタグで囲んでuseForm内で設定したValueをnameに入れる
②スロットコンテンツにfieldを渡す。
③スロット内部にinput要素を記述する。fieldのイベントを使うことでnameで指定した値に連動することができる

``` html
<form.Field
name="lastName"
>
    <template v-slot="{ field }">
      <label :for="field.name">姓</label>
      <input
        :name="field.name"
        :value="field.state.value"
      />
    </template>
</form.Field>
```

2. バリデーション

Fieldのコンポーネントの中にonBlurやonSubmitに関数を設定することでバリデーションを実施できます。
エラーの内容は`field.state.meta.errors`に格納されるので、その内容を表示するだけで管理できます。
また、<form> 要素のsubmitでuseFormのhandleSubmitを実行しています。
これをするとField内に紐づいているonSubmit関数が全て呼ばれて全体のバリデーションを走らせることができます。

```
  <form
    @submit.prevent.stop="form.handleSubmit();
    "
  >
    <div>
      <form.Field
        name="lastName"
        :validators="{
          onBlur: validateLastName,
          onSubmit: validateLastName,
        }"
      >
        <template #default="{ field }">
          <input
            :value="field.state.value"
            @input="(e) => field.handleChange(e.target.value)"
          />
          <p v-if="field.state.meta.errors.length">
            {{ field.state.meta.errors[0] }}
          </p>
        </template>
      </form.Field>
    </div>
```


## 結論

pureにVueで書くより覚えることが多いなと感じましたが、処理の流れが一方通行になっているなと感じました。
実務では今回の要件より複雑になるケースがほとんどだと思うので、導入することによって恩恵はありそうだなと思いました！

p.s. inputイベントにおける処理にて、tanstack内のfield関数を使う必要があるのでv-modelの記述を愚直に書くことができません。

## 参考文献
https://tanstack.com/form/latest](https://tanstack.com/form/latest/docs/framework/vue/guides/basic-concepts
https://stackblitz.com/github/tanstack/form/tree/main/examples/vue/simple?embed=1&theme=dark&preset=node&file=src/App.vue
