---
title: "VueでもTanstackが使いたい!!!~TanStack Form編~"
emoji: "🌊"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Vue","TanStack","TypeScript"]
published: false
---

## Tanstack Formについて

TanstackはReactの文脈で語られることが多いですが、ヘッドレスなユーティリティ群なのでReact以外のユーザも利用できる機能がいくつか存在します。
Tanstackには`Tanstack Query`や`Tanstack Router`、最近だと`Tanstack AI`が発表されましたがその中にフォームを取り扱った`TanstackForm`というものがあります。

`TanstackForm`公式の説明を見てみると説明文としては `Headless UI for building performant and type-safe forms`（高性能で型安全なフォームを構築するためのヘッドレスUI）ライブラリになります。

Vueでも`TanstackForm`を利用できるとのことなので、試しに動かしてみようと思います。

### フォームの要件

* 名前を登録するフォーム
* バリデーション条件
    * ブラーしたタイミングで検知
* バリデーション内容
    * 空文字入力の場合


## 実装例

### 素のVueで実装

以下のようになります。


``` vue
<script setup lang="ts">
import { ref, computed } from 'vue'

const userName = ref('')
const userNameTouched = ref(false)

const userNameError = computed<string | null>(() => {
  if (!userNameTouched.value) return null
  if (!userName.value) {
    return '名前は必須です'
  }
  return null
})

const handleSubmit = async (e: Event) => {
  userNameTouched.value = true
  if (userNameError.value) return
  alert(userName.value)
}
</script>

<template>
  <form @submit.prevent.stop="handleSubmit">
    <div>
      <label for="userName">名前</label>
      <input
        id="userName"
        name="userName"
        v-model="userName"
        @blur="userNameTouched = true"
      />
      <p v-if="userNameError">{{ userNameError }}</p>
    </div>
    <button type="submit">Submit</button>
  </form>
</template>
```

要件自体はシンプルですが、ブラー用、エラー判定用にリアクティブな値を持っており、バリデーションが複雑になるとコードから仕様を理解することに苦労しそうですね。
また、イベント`@blur`で状態を更新しているので、どこで状態が切り替わっているのか迷いそうです。


### TanstackFormを使った書き方

TanstackFormで上記の内容を書く場合、以下の書き方になります。

``` vue
<script setup lang="ts">
import { useForm } from '@tanstack/vue-form';

const formInstance = useForm({
  defaultValues: { userName: '' },
  onSubmit: async ({ value }) => {
    alert(value.userName);
  },
});

const validateUserName = ({ value }: { value: string }) => {
  if (!value) return '名前は必須です';
  return undefined;
};
</script>

<template>
  <form @submit.prevent.stop="formInstance.handleSubmit">
    <formInstance.Field
      name="userName"
      :validators="{ onBlur: validateUserName, onSubmit: validateUserName }"
    >
      <template #default="{ field }">
        <label :for="field.name">名前</label>
        <input
          :id="field.name"
          :name="field.name"
          :value="field.state.value"
          @input="(e) => field.handleChange((e.target as HTMLInputElement).value)"
          @blur="field.handleBlur"
        />
        <p v-if="field.state.meta.errors.length">
          {{ field.state.meta.errors[0] }}
        </p>
      </template>
    </formInstance.Field>
    <button type="submit">Submit</button>
  </form>
</template>
```

かなり違いますね。
必要な部分だけ抜粋しつつ、１つずづ見ていきましょう。

1. `useForm``

`@tanstack/vue-form`からuseFormを利用しています。宣言的にフォームの挙動を書くことができます。

  ```ts
  const formInstance = useForm({
    defaultValues: { userName: '' },
    onSubmit: async ({ value }) => {
      alert(value.userName);
    },
  });
  ```

  また、useFormの戻り値であるformInstanceをtemplate内で利用します。
  templateにuserNameを連携するには以下のように記述します。

  ```vue
  <formInstance.Field name="userName">
    <template v-slot="{ field }">
      <label :for="field.name">名前</label>
      <input
        :name="field.name"
        :value="field.state.value"
      />
    </template>
  </formInstance.Field>
  ```

上記のコードでやっていることは以下の通りです。
  ①`formInstance.Field`というタグで囲んでuseForm内で設定した値をnameに入れる（今回の場合は`name="userName"`）
  ②スロットコンテンツにfieldを渡す。
  ③スロット内部にinput要素を`field`経由で記述する。fieldを使うことでuseFormで指定した値に連動することができる

2. バリデーション

Fieldのコンポーネントの中にonBlurやonSubmitに関数を設定することでバリデーションを実施できます。
エラーの内容は`field.state.meta.errors`に格納されるので、その内容を表示するだけで管理できます。
また、バリデーションの発火タイミングは、Fieldの`validators`に記述できます。今回の場合はonBlurとonSubmitを指定しています。

```
  <form @submit.prevent.stop="formInstance.handleSubmit">
    <formInstance.Field
      name="userName"
      :validators="{ onBlur: validateUserName, onSubmit: validateUserName }"
    >
      <template #default="{ field }">
        <input
          :value="field.state.value"
          @input="(e) => field.handleChange((e.target as HTMLInputElement).value)"
        />
        <p v-if="field.state.meta.errors.length">
          {{ field.state.meta.errors[0] }}
        </p>
      </template>
    </formInstance.Field>
  </form>
```


## 感想

素のVueで書くより覚えることが多いなと感じましたが、処理の流れが一方通行になっているなと感じました。
実務では今回の要件より複雑になるケースがほとんどだと思うので、導入することによって見通しが良くなりそうです。

## 参考文献
https://tanstack.com/form/latest](https://tanstack.com/form/latest/docs/framework/vue/guides/basic-concepts
https://stackblitz.com/github/tanstack/form/tree/main/examples/vue/simple?embed=1&theme=dark&preset=node&file=src/App.vue
